import socket
import sys

sys.path.append("/home/toto/projet_sae302/utils")
from crypto import dechiffrer_une_couche

NAME = sys.argv[1]
PORT = int(sys.argv[2])
KEY = int(sys.argv[3])

BUFFER_SIZE = 4096

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(("0.0.0.0", PORT))
s.listen(5)

print(f" Routeur {NAME} en écoute sur le port {PORT}")

while True:
    conn, addr = s.accept()
    data = conn.recv(BUFFER_SIZE).decode()

    print(f" {NAME} a reçu brut : {data}")

    #  PAS DE int() ICI
    message_dechiffre = dechiffrer_une_couche(data, KEY)
    print(f" {NAME} après déchiffrement : {message_dechiffre}")

    conn.close()

    ip, port, contenu = message_dechiffre.split("|", 2)
    port = int(port)

    print(f" {NAME} envoie vers {ip}:{port}")
    print(f" Contenu : {contenu}")

    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s2.connect((ip, port))
    s2.send(contenu.encode())
    s2.close()
